/*! e50-editor 2015-01-26 */
angular.module("E50Editor",[]),angular.module("E50Editor").directive("e50Bind",["$timeout","$document","taSelection",function(a,b,c){return{require:"ngModel",link:function(d,e,f,g){var h=e.attr("contenteditable");g.$render=function(){e.html(g.$viewValue)},h&&(e.bind("keyup",function(){g.$setViewValue(e.html()),d.$apply()}),e.bind("mouseup",function(){d.$apply()})),e.bind("focus",function(){e.addClass("focused"),a(function(){d.focused=!0,d.edit=!0})}),e.bind("dragover",function(a){a.preventDefault(),a.stopPropagation(),e.addClass("drag-over")}),e.bind("dragleave",function(a){a.preventDefault(),a.stopPropagation(),e.removeClass("drag-over")});var i=function(a){a.preventDefault(),a.stopPropagation();var f=angular.element(a.target);f.hasClass("placeholder")&&(c.setSelectionToElementStart(a.target),f.remove());var h=a.originalEvent.dataTransfer;return angular.forEach(h.files,function(a){var c=new FileReader;c.onload=function(a){b[0].execCommand("insertImage",!1,a.target.result),e.removeClass("drag-over"),g.$setViewValue(e.html()),d.$apply()},c.readAsDataURL(a)}),!1};e.bind("drop",i),d.$on("$destroy",function(){e.unbind("drop",i)})}}}]),angular.module("E50Editor").directive("e50Editor",function(){var a=['<div e50-toolbars buttons="buttons"></div>','<div class="template" e50-template ng-model="html" buttons="buttons" ng-show="!toggle"></div>','<textarea ng-model="html" ng-show="toggle"></textarea>'];return{restrict:"EA",template:a.join(""),scope:{html:"=ngModel",buttons:"=?",toggle:"=?"}}}),angular.module("E50Editor").directive("e50Template",["taSelection","$document","$timeout",function(a){return{require:"ngModel",scope:{html:"=ngModel",buttons:"="},link:function(b,c,d,e){function f(){var a=$(c).find("[editable]");return a.length===h?!1:(h=a.length,b.buttons={},angular.forEach(a,function(a){var c=angular.element(a);c.attr("contenteditable",!0),b.buttons[c.attr("editable")]={focused:!1,buttons:c.attr("format").split(",")}}),void e.$setViewValue(c.html()))}function g(a){var c=$(a.target),d=c.closest("[editable]"),e=c.closest(".format-button");if(!d.length&&!e.length)return void Object.keys(b.buttons).forEach(function(a){b.buttons[a].focused=!1});var f=d.attr("editable");b.buttons[f]&&Object.keys(b.buttons).forEach(function(a){b.buttons[a].focused=f===a}),b.$apply()}b.buttons=b.buttons||{};var h=$(c).find("[editable]").length;b.$watch("html",function(a,b){return a||a!==b?void f():!1});var i=angular.element(document);i.bind("mousedown",g),i.bind("mouseup",b.$apply.bind(b)),b.$on("$destroy",function(){i.unbind("mousedown",g),i.unbind("mouseup",b.$apply.bind(b))}),e.$render=function(){c.html(e.$viewValue)},b.html||e.$setViewValue(c.html()),c.bind("keyup",function(){e.$setViewValue(c.html()),b.$apply()}),c.bind("dragover",function(a){a.preventDefault(),a.stopPropagation(),c.addClass("drag-over")}),c.bind("dragleave",function(a){a.preventDefault(),a.stopPropagation(),c.removeClass("drag-over")});var j=function(d){d.preventDefault(),d.stopPropagation();{var f=angular.element(d.target);f.closest("[editable]")}f.hasClass("placeholder")?a.setSelectionToElementStart(d.target):a.setSelectionToElementEnd(d.target);var g=d.originalEvent.dataTransfer;return angular.forEach(g.files,function(a){var d=/image.*/;if(!a.type.match(d))return void alert("Only images allowed");var g=new FileReader;g.onload=function(a){if(f.hasClass("placeholder"))f.attr("src",a.target.result),f.removeClass("placeholder");else{var d=new Image;d.src=a.target.result}c.removeClass("drag-over"),e.$setViewValue(c.html()),b.$apply()},g.readAsDataURL(a)}),!1};c.bind("drop",j),b.$on("$destroy",function(){c.unbind("drop",j)})}}}]),angular.module("E50Editor").directive("e50Toolbars",["E50EditorButtons","E50EditorIcons",function(a,b){var c=['<div class="toolbars">','<div class="group" ng-repeat="(key,editable) in buttons" ng-show="editable.focused">','<button type="button" unselectable="on" ng-repeat="btn in editable.buttons" class="format-button" ng-click="execute(btn)" ng-bind-html="name(btn)" ng-class="{active:isActive(btn)}"></button>',"</div>","</div>"];return{scope:{buttons:"="},template:c.join(""),link:function(c){c.name=function(c){var d=b(c);return d?d:a[c].name},c.isActive=function(b){return a[b].isActive()},c.execute=function(b){return a[b].execute()}}}}]),angular.module("E50Editor").factory("E50DefaultToolbar",function(){return[["h1","h2","h3","h4","h5","h6","p","pre","blockquote"],["insertOrderedList","insertUnorderedList"],["bold","italic","underline","justifyLeft","justifyCenter","justifyRight"]]}),angular.module("E50Editor").factory("E50EditorButtons",["E50ExecCommand","taBrowserTag","taSelection",function(a,b,c){function d(a){this.name=a,this.isActive=function(){return document.queryCommandValue("formatBlock").toLowerCase()===a},this.execute=function(){i("formatBlock",!1,"<"+b(a)+">")}}function e(a){this.name=a,this.isActive=function(){return document.queryCommandState(a)},this.execute=function(){i(a)}}function f(){this.name="image",this.isActive=function(){var a=c.getSelectionElement();return"IMG"===a.tagName},this.execute=function(){var a=window.prompt("Image url","http://");$document[0].execCommand("insertImage",!1,a)}}function g(a,b){this.name=a,this.execute=function(){i("insertHTML",!1,b)},this.isActive=angular.noop}function h(){this.execute=function(){var a=window.prompt("Link?","http://");i("createLink",!1,a)},this.isActive=function(){var a=c.getSelectionElement();return $(a).closest("a").length}}var i=a,j=["h1","h2","h3","h4","h5","h6","p","pre","blockquote"],k=["bold","italic","underline","justifyLeft","justifyCenter","justifyRight","insertOrderedList","insertUnorderedList"],l={};return j.forEach(function(a){l[a]=new d(a)}),k.forEach(function(a){l[a]=new e(a)}),l.image=new f,l.placeholder=new g("placeholder",'<img src="placeholder.png" class="placeholder" alt="Placeholder"/>'),l.link=new h,l.factory=function(a){var b={FormatCommand:d,StyleCommand:e,InsertCommand:g,LinkCommand:h,ImageCommand:f};return"undefined"!==b[a]?b[a]:!1},l}]),angular.module("E50Editor").factory("E50EditorIcons",function(){function a(a){return'<i class="fa '+a+'" unselectable="on">'}var b={blockquote:"fa-quote-right",bold:"fa-bold",italic:"fa-italic",underline:"fa-underline",justifyLeft:"fa-align-left",justifyCenter:"fa-align-center",justifyRight:"fa-align-right",insertOrderedList:"fa-list-ol",insertUnorderedList:"fa-list-ul",placeholder:"fa-image",link:"fa-link"};return function(c){return b[c]?a(b[c]):!1}}),angular.module("E50Editor").factory("E50ExecCommand",["taExecCommand",function(a){return a("p")}]),angular.module("E50Editor").factory("E50SelectionXY",function(){return function(){var a,b,c,d=document.selection,e=0,f=0;if(d)"Control"!=d.type&&(a=d.createRange(),a.collapse(!0),e=a.boundingLeft,f=a.boundingTop);else if(window.getSelection&&(d=window.getSelection(),d.rangeCount&&(a=d.getRangeAt(0).cloneRange(),a.getClientRects&&(a.collapse(!0),b=a.getClientRects(),b.length>0&&(c=a.getClientRects()[0]),e=c.left,f=c.top),0==e&&0==f))){var g=document.createElement("span");if(g.getClientRects){g.appendChild(document.createTextNode("â€‹")),a.insertNode(g),c=g.getClientRects()[0],e=c.left,f=c.top;var h=g.parentNode;h.removeChild(g),h.normalize()}}return{x:e,y:f}}}),angular.module("e50Editor.tpls",["views/e50-editor.tpl.html"]),angular.module("views/e50-editor.tpl.html",[]).run(["$templateCache",function(a){a.put("views/e50-editor.tpl.html",'<div class="e50-editor">\n  \n  <a href="" ng-click="edit=!edit" class="toggle">\n    <i class="fa fa-edit"></i>\n  </a>\n  \n  <div class="format-buttons" ng-show="edit">\n    <div ng-repeat="group in toolbars">\n      <button type="button" unselectable="on" ng-repeat="button in group" ng-bind-html="name(button)" ng-click="execute(button)" ng-disabled="isDisabled()" tabindex="-1" ng-class="{active:isActive(button)}"></button>\n    </div>\n  </div>\n\n  <div class="live-editor" contenteditable="true" e50-bind ng-model="html" ng-transclude=""></div>\n\n</div>')}]);
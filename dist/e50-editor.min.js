/*! e50-editor 2015-02-23 */
angular.module("E50Editor",["ngSanitize"]),angular.module("E50Editor").directive("e50Editor",function(){var a=['<div e50-popover class="e50-popover"></div>','<div e50-image class="e50-image"></div>','<div e50-toolbars buttons="buttons" iframe-id="iframeId" override="override"></div>','<div class="template" e50-template ng-model="html" ng-show="!toggle"></div>','<ng-include src="footerTpl"></ng-include>','<textarea ng-model="html" ng-show="toggle" style="width:100%;height:100%;border: 1px solid #e4e4e4;padding:15px;"></textarea>'];return{restrict:"EA",template:a.join(""),scope:{html:"=ngModel",buttons:"=?",toggle:"=?",iframeId:"=?",override:"=?",imageSaved:"=?",aviaryOptions:"=?",footerTpl:"="}}}),angular.module("E50Editor").directive("e50Iframe",["$compile","E50Documents","E50EditorConfig",function(a,b,c){return{scope:{html:"=ngModel",toggle:"=?",buttons:"=?",override:"=?",iframeId:"@e50Iframe",imageSaved:"=?",aviaryOptions:"=?",footerTpl:"="},link:function(d,e){d.template=d.template||"iframe-template.tpl.html";var f=angular.element(document.createElement("iframe"));d.$on("$destroy",function(){f.remove(),delete b.docs[d.id],d.$emit("e50Document",d.id,!1)}),e.html(f),f=e.find("iframe");var g=f.contents();g.find("head").append("<style>.ng-hide{display:none !important;}body{margin:0;padding:0;}*:focus{outline:none;}"),g.find("head").append('<link href="'+c.fontAwesome+'" rel="stylesheet"/>');var h=g.find("body");h.css({margin:0,padding:0}),b.set(d.iframeId,f),d.$emit("e50Document",d.iframeId,!0,f);var i=["<div e50-editor",'ng-model="html"','toggle="toggle"','buttons="buttons"','iframe-id="iframeId"','override="override"','image-saved="imageSaved"','aviary-options="aviaryOptions"','footer-tpl="footerTpl">',"initial editable content</div>"].join(" "),j=a(i)(d);h.append(j);var k=angular.element(d.html),l=k.find("img");f.height(500),l.on("load",function(){})}}}]),angular.module("E50Editor").directive("e50Image",["$timeout","E50EditorConfig",function(a,b){var c=['<div class="popovers">','<div ng-repeat="img in imagePopovers" ng-show="img.show" ng-attr-class="img-popover-{{img.id}} image-edit"  ng-mouseenter="img.show=true">','<a href="" ng-click="toggleInput(img)" class="edit"><i class="fa  fa-ellipsis-v"></i></a>','<a href="" class="trash"><i class="fa fa-trash-o" ng-click="trash(img)"></i></a>','<form ng-submit="setImageUrl(img)">','<input type="text" ng-model="img.src" placeholder="Enter url & hit enter or" ng-if="img.showInput"/>','<a href="" ng-click="openAviary(img)" class="edit-photo" ng-if="img.showInput">Edit</a>',"</form>",'<form ng-show="img.showInput">','<input type="file" ng-attr-id="file-upload-{{img.id}}"/>',"</form>","</div>","</div>"];return{template:c.join(""),link:function(c,d){function e(b){var e=angular.element(b.target),f=parseInt(e.attr("image-id"),10);angular.forEach(c.imagePopovers,function(a,b){a.show=f==b});var g=e.offset(),h=d.find(".img-popover-"+f);a(function(){g.top=g.top+5,g.left=g.left+e.width()-h.width()-5,d.css(g),d.animate({opacity:1},200)}),c.$apply()}function f(a){var b=angular.element(a.toElement||a.relatedTarget),d=b.hasClass("e50-image")||b.closest(".e50-image").length;return d?!0:(angular.forEach(c.imagePopovers,function(a){a.show=!1}),void c.$apply())}function g(a){return a.preventDefault(),a.stopPropagation(),!1}function h(a){a.preventDefault(),a.stopPropagation();var b=angular.element(a.target),d=a.originalEvent.dataTransfer.files[0],e=new FileReader;return e.onload=function(a){var d=new Image;d.src=a.target.result,l.launch({image:d,onSave:function(a,d){c.imageSaved(d,b),b.attr("src",d),c.$emit("updateViewValue")}})},e.readAsDataURL(d),!1}function i(){var a=d.parent().find(".placeholder");angular.forEach(a,function(a,d){k[d]=a;var e=angular.element(a);e.attr("image-id",d);var f=e.attr("src"),g=-1!==f.indexOf(b.placeholder);c.imagePopovers[d]={id:d,show:!1,src:g?"":e.attr("src")}}),a.unbind("mouseover",e),a.unbind("mouseleave",f),a.bind("mouseover",e),a.bind("mouseleave",f),a.unbind("dragover",g),a.bind("dragover",g),a.unbind("drop",h),a.bind("drop",h)}function j(a){var b=angular.element(a.target),d=b.attr("id").split("-").pop(),e=angular.element(k[d]),f=new Image,g=a.target.files[0],h=new FileReader;h.onload=function(a){f.src=a.target.result,l.launch({image:f,onSave:function(a,d){c.imageSaved(d,e),b.val(""),c.$emit("updateViewValue")},onClose:function(){b.val("")}})},h.readAsDataURL(g)}c.aviaryOptions=c.aviaryOptions||"all",d.css({position:"absolute"});var k={};c.imagePopovers={};var l=new Aviary.Feather({apiKey:b.aviaryKey,tools:c.aviaryOptions,onError:function(){console.log(arguments)}});c.openAviary=function(a){if(c.isPlaceholder(a))return void alert("Please upload an image to edit");var d=angular.element(k[a.id]),e=d.attr("src"),f=-1!==e.indexOf(b.placeholder);if(f)return!1;var g=new Image;g.src=e,l.launch({image:g,onSave:function(a,b){c.imageSaved(b,d),d.attr("src",b),c.$emit("updateViewValue")}})},c.isPlaceholder=function(a){var c=angular.element(k[a.id]),d=c.attr("src");return-1!==d.indexOf(b.placeholder)},c.trash=function(a){var d=angular.element(k[a.id]);if(c.isPlaceholder(a))d.remove();else{var e=window.confirm("Are you sure you want to delete this image?");if(!e)return!1;d.attr("src",b.placeholder)}a.show=!1,c.$emit("updateViewValue")},c.$watch("html",function(a,b){(a||a!==b)&&i()}),c.toggleInput=function(b){var c=angular.element(k[b.id]);b.showInput=!b.showInput,b.showInput&&a(function(){c.focus(),c[0].setSelectionRange?c[0].setSelectionRange(0,0):c.val(c.val())})},c.setImageUrl=function(a){var c=angular.element(k[a.id]),d=""!==a.src?a.src:b.placeholder;c.attr("src",d),a.showInput=!1},c.$watch("imagePopovers",function(a){if(a){var b=d.find("input");angular.forEach(b,function(a){var b=angular.element(a);b.unbind("change",j),b.bind("change",j)})}},!0)}}}]),angular.module("E50Editor").directive("e50Popover",["$timeout","E50Documents","E50EditorConfig",function(a,b,c){var d=['<div class="link-manager" ng-repeat="popover in popovers" ng-show="popover.show">','<input type="text" ng-model="popover.link" />','<a href="" target="_blank" ng-attr-href="{{popover.link}}">Open</a>','<a href="" target="_blank" ng-click="unlink(popover)" ng-show="isLink(popover)"><i class="fa fa-unlink"></i></a>',"</div>"];return{template:d.join(""),link:function(d,e){var f,g=b.get(d.iframeId);d.unlink=function(b){var c="a"===f[0].tagName.toLowerCase();c||(f=f.closest("a")),a(function(){var a=rangy.createRange();a.selectNodeContents(f[0]);var c=rangy.getIframeSelection(g[0]);c.setSingleRange(a),f=null,b.show=!1;var d=g[0].document||g[0].contentWindow.document;d.execCommand("unlink")})},d.isButton=function(a){return-1!==a.id.indexOf("button")},d.isLink=function(a){return-1!==a.id.indexOf("link")},d.$on("e50Popover",function(b,g){f=g;var h=g.attr(c.attrs.popover);angular.forEach(d.popovers,function(a,b){a.show=b===h&&"false"!==h}),e.css({opacity:0}),a(function(){var a=g.offset();a.top=a.top-e.height()-10;var b=(d.popovers[g.attr(c.attrs.popover)],0);b+=parseInt(g.css("padding-right")),b+=parseInt(g.css("margin-right")),a.left=Math.ceil(a.left)+g.width()-e.width()+b,e.css(a),e.animate({top:a.top+5,opacity:1},200)})})}}}]),angular.module("E50Editor").directive("e50Template",["E50Documents","E50EditorConfig",function(a,b){return{require:"ngModel",link:function(c,d,e,f){function g(){var a=$(d).find("["+b.attrs.editable+"]");return a.length===m?!1:(m=a.length,c.buttons={},angular.forEach(a,function(a){var d=angular.element(a);d.attr("contenteditable",!0),c.buttons[d.attr(b.attrs.editable)]={focused:!1,buttons:d.attr(b.attrs.format)?d.attr(b.attrs.format).split(","):[]}}),void f.$setViewValue(d.html()))}function h(a){var d=$(a.target),e=d.closest("["+b.attrs.editable+"]"),f=d.closest(".format-button");if(!e.length&&!f.length)return Object.keys(c.buttons).forEach(function(a){c.buttons[a].focused=!1}),void(c.showPopover=!1);var g=e.attr(b.attrs.editable);c.buttons[g]&&Object.keys(c.buttons).forEach(function(a){c.buttons[a].focused=g===a}),c.$apply()}function i(){f.$setViewValue(d.html()),c.$apply()}function j(a){var d=angular.element(a.target),e=d.closest(".e50-popover");return d.attr(b.attrs.popover)||(d=d.closest("["+b.attrs.popover+"]")),e.length||d.length?(c.showPopover=!0,c.$emit("e50Popover",d),void c.$apply()):(c.showPopover=!1,void angular.forEach(c.popovers,function(a){a.show=!1}))}function k(){var a=angular.element(d),e=a.find("["+b.attrs.popover+"]");return e.length===t?!1:(t=e.length,u={},c.popovers={},void angular.forEach(e,function(a,d){var e=angular.element(a),f=e.attr(b.attrs.popover);if("false"!==f){for(;u[f];)f+=d;e.attr(b.attrs.popover,f),u[f]=e,c.popovers[f]={id:f,link:e.attr("href")||"http://",show:!1}}}))}function l(a){var e=angular.element(a.target),g="a"===a.target.tagName.toLowerCase();if(g||(e=e.closest("a")),g){var h=e.attr(b.attrs.popover);if("false"===h)return;if(!h){for(h="link:1";u[h];)h+=1;e.attr(b.attrs.popover,h),u[h]=e,f.$setViewValue(d.html()),c.$apply()}}}c.buttons=c.buttons||{},c.html||f.$setViewValue(d.html());var m=$(d).find("["+b.attrs.editable+"]").length;c.$watch("html",function(a,b){return a||a!==b?void g():!1});var n=a.get(c.iframeId),o=n[0].contentDocument||n[0].contentWindow.document,p=angular.element(o||document),q=p[0]!==document;if(q)var r=angular.element(document);p.bind("mousedown",h),p.bind("mouseup",i),q&&(r.bind("mousedown",h),r.bind("mouseup",i)),c.$on("$destroy",function(){p.unbind("mousedown",h),p.unbind("mouseup",i),q&&(r.unbind("mousedown",h),r.unbind("mouseup",i))}),f.$render=function(){d.html(f.$viewValue)},d.bind("keyup",function(){f.$setViewValue(d.html()),c.$apply()}),d.bind("dragover",function(a){a.preventDefault(),a.stopPropagation(),d.addClass("drag-over")}),d.bind("dragleave",function(a){a.preventDefault(),a.stopPropagation(),d.removeClass("drag-over")});var s=function(a){return a.preventDefault(),a.stopPropagation(),!1};d.bind("drop",s),c.popovers={},d.bind("mousedown",j),q&&r.bind("mousedown",j);var t=!1,u={};c.$watch("html",function(a,b){(a||a!==b)&&k()}),c.$watch("popovers",function(){angular.forEach(c.popovers,function(a,b){u[b]&&u[b].attr("href",a.link)}),f.$setViewValue(d.html())},!0),c.$on("$destroy",function(){d.unbind("drop",s),r.unbind("mousedown",j)}),d.bind("mousedown",l),c.$on("e50AddText",function(a,b,e){if(b!==c.iframeId)return!1;var g=rangy.getIframeSelection(n[0]),h=g.getRangeAt(0);h.insertNode(document.createTextNode(e)),f.$setViewValue(d.html())}),c.$on("updateViewValue",function(){f.$setViewValue(d.html())}),c.$on("updateViewValue")}}}]),angular.module("E50Editor").directive("e50Toolbars",["E50EditorButtons","E50EditorIcons","$document","E50Documents",function(a,b,c,d){var e=['<div class="toolbars" ng-if="!override">','<div class="group" ng-repeat="(key,editable) in buttons" ng-show="editable.focused">','<button type="button" unselectable="on" ng-repeat="btn in editable.buttons" class="format-button" ng-click="execute(btn)" ng-bind-html="name(btn)" ng-class="{active:isActive(btn)}"></button>',"</div>","</div>"];return{scope:{buttons:"=",iframeId:"=",override:"=?"},template:e.join(""),link:function(e){function f(b){g||(h=d.get(e.iframeId),g=h[0].contentDocument||h[0].contentWindow.document);var f=a[b];return f.iframe=h,f.setDocument(g||c[0]),f}var g,h=d.get(e.iframeId);h&&(g=h[0].contentDocument||h[0].contentWindow.document),e.name=function(c){var d=b(c);return a[c]?d?d:a[c].name:!1},e.isActive=function(a){try{return f(a).isActive()}catch(b){}},e.execute=function(a){return f(a).execute()}}}}]),angular.module("E50Editor").factory("E50BrowswerTag",function(){return function(a){return a?""===a?void 0===_browserDetect.ie?"div":_browserDetect.ie<=8?"P":"p":_browserDetect.ie<=8?a.toUpperCase():a:_browserDetect.ie<=8?"P":"p"}}),angular.module("E50Editor").factory("E50Documents",function(){return{docs:{},get:function(a){return"undefined"!==this.docs[a]?this.docs[a]:!1},set:function(a,b){this.docs[a]=b}}}),angular.module("E50Editor").factory("E50EditorButtons",["E50BrowswerTag","E50Documents","E50EditorConfig",function(a,b,c){function d(a){this.document=a}function e(b){this.name=b,this.isActive=function(){return this.document.queryCommandValue("formatBlock").toLowerCase()===b},this.execute=function(){var c=this.isActive()?"P":b;this.document.execCommand("formatBlock",!1,"<"+a(c)+">")},this.setDocument=d}function f(a){this.name=a,this.isActive=function(){return this.document.queryCommandState(a)},this.execute=function(){var b=this.iframe[0].document||this.iframe[0].contentWindow.document||document;b.execCommand(a)},this.setDocument=d}function g(a,b){this.name=a,this.execute=function(){var a=this.iframe[0].document||this.iframe[0].contentWindow.document||document;a.execCommand("insertHTML",!1,b)},this.isActive=angular.noop,this.setDocument=d}function h(){this.execute=function(){var a=window.prompt("Link URL:","http://"),b=this.iframe[0].document||this.iframe[0].contentWindow.document||document;b.execCommand("createLink",!1,a)},this.isActive=function(){return!1},this.setDocument=d}var i=["h1","h2","h3","h4","h5","h6","p","pre","blockquote"],j=["bold","italic","underline","justifyLeft","justifyCenter","justifyRight","insertOrderedList","insertUnorderedList","unlink"],k={};return i.forEach(function(a){k[a]=new e(a)}),j.forEach(function(a){k[a]=new f(a)}),k.placeholder=new g("placeholder",'<img src="'+c.placeholder+'" class="placeholder" alt="Placeholder"/>'),k.link=new h,k.factory=function(a){var b={FormatCommand:e,StyleCommand:f,InsertCommand:g,LinkCommand:h,ImageCommand:ImageCommand};return"undefined"!==b[a]?b[a]:!1},k}]),angular.module("E50Editor").factory("E50EditorConfig",function(){return{fontAwesome:"../bower_components/font-awesome/css/font-awesome.css",placeholder:"images/placeholder.png",aviaryKey:null,attrs:{editable:"cs-editable",format:"cs-format",popover:"cs-popover"}}}),angular.module("E50Editor").factory("E50EditorIcons",function(){function a(a){return'<i class="fa '+a+'" unselectable="on">'}var b={blockquote:"fa-quote-right",bold:"fa-bold",italic:"fa-italic",underline:"fa-underline",justifyLeft:"fa-align-left",justifyCenter:"fa-align-center",justifyRight:"fa-align-right",insertOrderedList:"fa-list-ol",insertUnorderedList:"fa-list-ul",placeholder:"fa-image",link:"fa-link"};return function(c){return b[c]?a(b[c]):!1}}),angular.module("E50Editor").factory("E50ExecCommand",["taExecCommand",function(a){return a("p")}]),angular.module("E50Editor").factory("E50SelectionXY",function(){return function(){var a,b,c,d=document.selection,e=0,f=0;if(d)"Control"!=d.type&&(a=d.createRange(),a.collapse(!0),e=a.boundingLeft,f=a.boundingTop);else if(window.getSelection&&(d=window.getSelection(),d.rangeCount&&(a=d.getRangeAt(0).cloneRange(),a.getClientRects&&(a.collapse(!0),b=a.getClientRects(),b.length>0&&(c=a.getClientRects()[0]),e=c.left,f=c.top),0==e&&0==f))){var g=document.createElement("span");if(g.getClientRects){g.appendChild(document.createTextNode("​")),a.insertNode(g),c=g.getClientRects()[0],e=c.left,f=c.top;var h=g.parentNode;h.removeChild(g),h.normalize()}}return{x:e,y:f}}}),angular.module("e50Editor.tpls",["views/e50-editor.tpl.html"]),angular.module("views/e50-editor.tpl.html",[]).run(["$templateCache",function(a){a.put("views/e50-editor.tpl.html",'<div class="e50-editor">\n  \n  <a href="" ng-click="edit=!edit" class="toggle">\n    <i class="fa fa-edit"></i>\n  </a>\n  \n  <div class="format-buttons" ng-show="edit">\n    <div ng-repeat="group in toolbars">\n      <button type="button" unselectable="on" ng-repeat="button in group" ng-bind-html="name(button)" ng-click="execute(button)" ng-disabled="isDisabled()" tabindex="-1" ng-class="{active:isActive(button)}"></button>\n    </div>\n  </div>\n\n  <div class="live-editor" contenteditable="true" e50-bind ng-model="html" ng-transclude=""></div>\n\n</div>')}]);
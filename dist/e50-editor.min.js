/*! e50-editor 2015-02-10 */
angular.module("E50Editor",["ngSanitize"]),angular.module("E50Editor").directive("e50Editor",function(){var a=['<div e50-popover class="e50-popover"></div>','<div e50-image class="e50-image"></div>','<div e50-toolbars buttons="buttons" iframe-id="iframeId" override="override"></div>','<div class="template" e50-template ng-model="html" ng-show="!toggle"></div>','<textarea ng-model="html" ng-show="toggle" style="width:100%;height:100%;border: 1px solid #e4e4e4;padding:15px;"></textarea>'];return{restrict:"EA",template:a.join(""),scope:{html:"=ngModel",buttons:"=?",toggle:"=?",iframeId:"=?",override:"=?",imageSaved:"=?"}}}),angular.module("E50Editor").directive("e50Iframe",["$compile","E50Documents","E50EditorConfig",function(a,b,c){return{scope:{html:"=ngModel",toggle:"=?",buttons:"=?",override:"=?",iframeId:"@e50Iframe",imageSaved:"=?"},link:function(d,e){d.template=d.template||"iframe-template.tpl.html";var f=angular.element(document.createElement("iframe"));d.$on("$destroy",function(){f.remove(),delete b.docs[d.id],d.$emit("e50Document",d.id,!1)}),e.html(f),f=e.find("iframe");var g=f.contents();g.find("head").append("<style>.ng-hide{display:none !important;}body{margin:0;padding:0;}*:focus{outline:none;}"),g.find("head").append('<link href="'+c.fontAwesome+'" rel="stylesheet"/>');var h=g.find("body");h.css({margin:0,padding:0}),b.set(d.iframeId,f),d.$emit("e50Document",d.iframeId,!0,f);var i='<div e50-editor ng-model="html" toggle="toggle" buttons="buttons" iframe-id="iframeId" override="override" image-saved="imageSaved">initial editable content</div>',j=a(i)(d);h.append(j);var k=angular.element(d.html),l=k.find("img");f.height(500),l.on("load",function(){})}}}]),angular.module("E50Editor").directive("e50Image",["$timeout","E50EditorConfig",function(a,b){var c=['<div class="image-popovers">','<div ng-repeat="img in imagePopovers" ng-show="img.show" ng-attr-class="img-popover-{{img.id}}" ng-mouseenter="img.show=true" ng-leave="img.show=true">','<a href="" ng-click="toggleInput(img)"><i class="fa  fa-ellipsis-v"></i></a>','<form ng-submit="setImageUrl(img)">','<input type="text" ng-model="img.src" placeholder="Enter url & hit enter" ng-if="!img.showInput"/>','<a href="" ng-click="openAviary(img)" ng-if="!isPlaceholder(img) && !img.showInput ">Edit</a>',"</form>","</div>","</div>"];return{template:c.join(""),link:function(c,d){function e(b){var e=angular.element(b.target),f=parseInt(e.attr("image-id"),10);angular.forEach(c.imagePopovers,function(a,b){a.show=f==b});var g=e.offset(),h=d.find(".img-popover-"+f);a(function(){g.top=g.top+5,g.left=g.left+e.width()-h.width()-10,d.css(g),d.animate({opacity:1},200)}),c.$apply()}function f(a){var b=angular.element(a.toElement||a.relatedTarget),d=b.hasClass("e50-image")||b.closest(".e50-image").length;return d?!0:(angular.forEach(c.imagePopovers,function(a){a.show=!1,a.showInput=!1}),void c.$apply())}function g(a){return a.preventDefault(),a.stopPropagation(),!1}function h(a){a.preventDefault(),a.stopPropagation();var b=angular.element(a.target),d=a.originalEvent.dataTransfer.files[0],e=new FileReader;return e.onload=function(a){var d=new Image;d.src=a.target.result,k.launch({image:d,onSave:function(a,d){c.imageSaved(d,b),b.attr("src",d),c.$emit("updateViewValue")}})},e.readAsDataURL(d),!1}function i(){var a=d.parent().find(".placeholder");angular.forEach(a,function(a,d){j[d]=a;var e=angular.element(a);e.attr("image-id",d);var f=e.attr("src"),g=-1!==f.indexOf(b.placeholder);c.imagePopovers[d]={id:d,show:!1,src:g?"":e.attr("src")}}),a.unbind("mouseover",e),a.unbind("mouseleave",f),a.bind("mouseover",e),a.bind("mouseleave",f),a.unbind("dragover",g),a.bind("dragover",g),a.unbind("drop",h),a.bind("drop",h)}d.css({position:"absolute",opacity:0});var j={};c.imagePopovers={};var k=new Aviary.Feather({apiKey:aviaryKey,tools:"all",onError:function(){console.log(arguments)}});c.openAviary=function(a){var d=angular.element(j[a.id]),e=d.attr("src"),f=-1!==e.indexOf(b.placeholder);if(f)return!1;var g=new Image;g.src=e,k.launch({image:g,onSave:function(a,b){c.imageSaved(b,d),d.attr("src",b),c.$emit("updateViewValue")}})},c.isPlaceholder=function(a){var c=angular.element(j[a.id]),d=c.attr("src");return-1!==d.indexOf(b.placeholder)},c.$watch("html",function(a,b){(a||a!==b)&&i()}),c.toggleInput=function(b){var c=angular.element(j[b.id]);b.showInput=!b.showInput,b.showInput&&a(function(){c.focus(),c[0].setSelectionRange?c[0].setSelectionRange(0,0):c.val(c.val())})},c.setImageUrl=function(a){var c=angular.element(j[a.id]),d=""!==a.src?a.src:b.placeholder;c.attr("src",d),a.showInput=!1}}}}]),angular.module("E50Editor").directive("e50Popover",["$timeout","E50Documents",function(a,b){var c=['<div class="link-manager" ng-repeat="popover in popovers" ng-show="popover.show">','<input type="text" ng-model="popover.link" />','<a href="" target="_blank" ng-attr-href="{{popover.link}}">Open</a>','<a href="" target="_blank" ng-click="unlink(popover)" ng-show="isLink(popover)"><i class="fa fa-unlink"></i></a>',"</div>"];return{template:c.join(""),link:function(c,d){var e,f=b.get(c.iframeId);c.unlink=function(b){var c="a"===e[0].tagName.toLowerCase();c||(e=e.closest("a")),a(function(){var a=rangy.createRange();a.selectNodeContents(e[0]);var c=rangy.getIframeSelection(f[0]);c.setSingleRange(a),e=null,b.show=!1;var d=f[0].document||f[0].contentWindow.document;d.execCommand("unlink")})},c.isButton=function(a){return-1!==a.id.indexOf("button")},c.isLink=function(a){return-1!==a.id.indexOf("link")},c.$on("e50Popover",function(b,f){e=f;var g=f.attr("popover");angular.forEach(c.popovers,function(a,b){a.show=b===g&&"false"!==g}),d.css({opacity:0}),a(function(){var a=f.offset();a.top=a.top-d.height()-10;var b=(c.popovers[f.attr("popover")],0);b+=parseInt(f.css("padding-right")),b+=parseInt(f.css("margin-right")),a.left=Math.ceil(a.left)+f.width()-d.width()+b,d.css(a),d.animate({top:a.top+5,opacity:1},200)})})}}}]),angular.module("E50Editor").directive("e50Template",["E50Documents",function(a){return{require:"ngModel",link:function(b,c,d,e){function f(){var a=$(c).find("[editable]");return a.length===l?!1:(l=a.length,b.buttons={},angular.forEach(a,function(a){var c=angular.element(a);c.attr("contenteditable",!0),b.buttons[c.attr("editable")]={focused:!1,buttons:c.attr("format")?c.attr("format").split(","):[]}}),void e.$setViewValue(c.html()))}function g(a){var c=$(a.target),d=c.closest("[editable]"),e=c.closest(".format-button");if(!d.length&&!e.length)return Object.keys(b.buttons).forEach(function(a){b.buttons[a].focused=!1}),void(b.showPopover=!1);var f=d.attr("editable");b.buttons[f]&&Object.keys(b.buttons).forEach(function(a){b.buttons[a].focused=f===a}),b.$apply()}function h(){e.$setViewValue(c.html()),b.$apply()}function i(a){var c=angular.element(a.target),d=c.closest(".e50-popover");return c.attr("popover")||(c=c.closest("[popover]")),d.length||c.length?(b.showPopover=!0,b.$emit("e50Popover",c),void b.$apply()):(b.showPopover=!1,void angular.forEach(b.popovers,function(a){a.show=!1}))}function j(){var a=angular.element(c),d=a.find("[popover]");return d.length===s?!1:(s=d.length,t={},b.popovers={},void angular.forEach(d,function(a,c){var d=angular.element(a),e=d.attr("popover");if("false"!==e){for(;t[e];)e+=c;d.attr("popover",e),t[e]=d,b.popovers[e]={id:e,link:d.attr("href")||"http://",show:!1}}}))}function k(a){var d=angular.element(a.target),f="a"===a.target.tagName.toLowerCase();if(f||(d=d.closest("a")),f){var g=d.attr("popover");if("false"===g)return;if(!g){for(g="link:1";t[g];)g+=1;d.attr("popover",g),t[g]=d,e.$setViewValue(c.html()),b.$apply()}}}b.buttons=b.buttons||{},b.html||e.$setViewValue(c.html());var l=$(c).find("[editable]").length;b.$watch("html",function(a,b){return a||a!==b?void f():!1});var m=a.get(b.iframeId),n=m[0].contentDocument||m[0].contentWindow.document,o=angular.element(n||document),p=o[0]!==document;if(p)var q=angular.element(document);o.bind("mousedown",g),o.bind("mouseup",h),p&&(q.bind("mousedown",g),q.bind("mouseup",h)),b.$on("$destroy",function(){o.unbind("mousedown",g),o.unbind("mouseup",h),p&&(q.unbind("mousedown",g),q.unbind("mouseup",h))}),e.$render=function(){c.html(e.$viewValue)},c.bind("keyup",function(){e.$setViewValue(c.html()),b.$apply()}),c.bind("dragover",function(a){a.preventDefault(),a.stopPropagation(),c.addClass("drag-over")}),c.bind("dragleave",function(a){a.preventDefault(),a.stopPropagation(),c.removeClass("drag-over")});var r=function(a){return a.preventDefault(),a.stopPropagation(),!1};c.bind("drop",r),b.popovers={},c.bind("mousedown",i),p&&q.bind("mousedown",i);var s=!1,t={};b.$watch("html",function(a,b){(a||a!==b)&&j()}),b.$watch("popovers",function(){angular.forEach(b.popovers,function(a,b){t[b]&&t[b].attr("href",a.link)}),e.$setViewValue(c.html())},!0),b.$on("$destroy",function(){c.unbind("drop",r),q.unbind("mousedown",i)}),c.bind("mousedown",k),b.$on("e50AddText",function(a,d,f){if(d!==b.iframeId)return!1;var g=rangy.getIframeSelection(m[0]),h=g.getRangeAt(0);h.insertNode(document.createTextNode(f)),e.$setViewValue(c.html())}),b.$on("updateViewValue",function(){e.$setViewValue(c.html()),b.$apply()})}}}]),angular.module("E50Editor").directive("e50Toolbars",["E50EditorButtons","E50EditorIcons","$document","E50Documents",function(a,b,c,d){var e=['<div class="toolbars" ng-if="!override">','<div class="group" ng-repeat="(key,editable) in buttons" ng-show="editable.focused">','<button type="button" unselectable="on" ng-repeat="btn in editable.buttons" class="format-button" ng-click="execute(btn)" ng-bind-html="name(btn)" ng-class="{active:isActive(btn)}"></button>',"</div>","</div>"];return{scope:{buttons:"=",iframeId:"=",override:"=?"},template:e.join(""),link:function(e){function f(b){g||(h=d.get(e.iframeId),g=h[0].contentDocument||h[0].contentWindow.document);var f=a[b];return f.iframe=h,f.setDocument(g||c[0]),f}var g,h=d.get(e.iframeId);h&&(g=h[0].contentDocument||h[0].contentWindow.document),e.name=function(c){var d=b(c);return a[c]?d?d:a[c].name:!1},e.isActive=function(a){try{return f(a).isActive()}catch(b){}},e.execute=function(a){return f(a).execute()}}}}]),angular.module("E50Editor").factory("E50BrowswerTag",function(){return function(a){return a?""===a?void 0===_browserDetect.ie?"div":_browserDetect.ie<=8?"P":"p":_browserDetect.ie<=8?a.toUpperCase():a:_browserDetect.ie<=8?"P":"p"}}),angular.module("E50Editor").factory("E50Documents",function(){return{docs:{},get:function(a){return"undefined"!==this.docs[a]?this.docs[a]:!1},set:function(a,b){this.docs[a]=b}}}),angular.module("E50Editor").factory("E50EditorButtons",["E50BrowswerTag","E50Documents","E50EditorConfig",function(a,b,c){function d(a){this.document=a}function e(b){this.name=b,this.isActive=function(){return this.document.queryCommandValue("formatBlock").toLowerCase()===b},this.execute=function(){var c=this.isActive()?"P":b;this.document.execCommand("formatBlock",!1,"<"+a(c)+">")},this.setDocument=d}function f(a){this.name=a,this.isActive=function(){return this.document.queryCommandState(a)},this.execute=function(){var b=this.iframe[0].document||this.iframe[0].contentWindow.document||document;b.execCommand(a)},this.setDocument=d}function g(a,b){this.name=a,this.execute=function(){var a=this.iframe[0].document||this.iframe[0].contentWindow.document||document;a.execCommand("insertHTML",!1,b)},this.isActive=angular.noop,this.setDocument=d}function h(){this.execute=function(){var a=window.prompt("Link URL:","http://"),b=this.iframe[0].document||this.iframe[0].contentWindow.document||document;b.execCommand("createLink",!1,a)},this.isActive=function(){return!1},this.setDocument=d}var i=["h1","h2","h3","h4","h5","h6","p","pre","blockquote"],j=["bold","italic","underline","justifyLeft","justifyCenter","justifyRight","insertOrderedList","insertUnorderedList","unlink"],k={};return i.forEach(function(a){k[a]=new e(a)}),j.forEach(function(a){k[a]=new f(a)}),k.placeholder=new g("placeholder",'<img src="'+c.placeholder+'" class="placeholder" alt="Placeholder"/>'),k.link=new h,k.factory=function(a){var b={FormatCommand:e,StyleCommand:f,InsertCommand:g,LinkCommand:h,ImageCommand:ImageCommand};return"undefined"!==b[a]?b[a]:!1},k}]),angular.module("E50Editor").factory("E50EditorConfig",function(){return{fontAwesome:"../bower_components/font-awesome/css/font-awesome.css",placeholder:"images/placeholder.png"}}),angular.module("E50Editor").factory("E50EditorIcons",function(){function a(a){return'<i class="fa '+a+'" unselectable="on">'}var b={blockquote:"fa-quote-right",bold:"fa-bold",italic:"fa-italic",underline:"fa-underline",justifyLeft:"fa-align-left",justifyCenter:"fa-align-center",justifyRight:"fa-align-right",insertOrderedList:"fa-list-ol",insertUnorderedList:"fa-list-ul",placeholder:"fa-image",link:"fa-link"};return function(c){return b[c]?a(b[c]):!1}}),angular.module("E50Editor").factory("E50ExecCommand",["taExecCommand",function(a){return a("p")}]),angular.module("E50Editor").factory("E50SelectionXY",function(){return function(){var a,b,c,d=document.selection,e=0,f=0;if(d)"Control"!=d.type&&(a=d.createRange(),a.collapse(!0),e=a.boundingLeft,f=a.boundingTop);else if(window.getSelection&&(d=window.getSelection(),d.rangeCount&&(a=d.getRangeAt(0).cloneRange(),a.getClientRects&&(a.collapse(!0),b=a.getClientRects(),b.length>0&&(c=a.getClientRects()[0]),e=c.left,f=c.top),0==e&&0==f))){var g=document.createElement("span");if(g.getClientRects){g.appendChild(document.createTextNode("​")),a.insertNode(g),c=g.getClientRects()[0],e=c.left,f=c.top;var h=g.parentNode;h.removeChild(g),h.normalize()}}return{x:e,y:f}}}),angular.module("e50Editor.tpls",["views/e50-editor.tpl.html"]),angular.module("views/e50-editor.tpl.html",[]).run(["$templateCache",function(a){a.put("views/e50-editor.tpl.html",'<div class="e50-editor">\n  \n  <a href="" ng-click="edit=!edit" class="toggle">\n    <i class="fa fa-edit"></i>\n  </a>\n  \n  <div class="format-buttons" ng-show="edit">\n    <div ng-repeat="group in toolbars">\n      <button type="button" unselectable="on" ng-repeat="button in group" ng-bind-html="name(button)" ng-click="execute(button)" ng-disabled="isDisabled()" tabindex="-1" ng-class="{active:isActive(button)}"></button>\n    </div>\n  </div>\n\n  <div class="live-editor" contenteditable="true" e50-bind ng-model="html" ng-transclude=""></div>\n\n</div>')}]);
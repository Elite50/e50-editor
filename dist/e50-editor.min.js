/*! e50-editor 2015-05-11 */
angular.module("E50Editor",["ngSanitize"]),angular.module("E50Editor").directive("e50Button",["$timeout","E50EditorConfig",function(a,b){var c=['<div class="link-manager" ng-repeat="btn in csButtons" ng-show="btn.show && !toggle">','<form ng-submit="setBtnLink(btn)"><input type="text" ng-model="btn.link" /></form>','<a href="" target="_blank" ng-attr-href="{{btn.link}}">Open</a>',"</div>"];return{template:c.join(""),link:function(c,d){function e(){var a=d.parent().find("[e50-template]").find("["+b.attrs.button+"]");angular.forEach(a,function(a,d){a=angular.element(a),h[d]=a,a.attr(b.attrs.button,d),c.csButtons[d]={id:d,show:!1,link:a.attr("href")||"http://"}}),a.unbind("mouseup",g),a.bind("mouseup",g);var e=d.find("input");e.unbind("keypress",f),e.bind("keypress",f),c.$emit("updateViewValue")}function f(b){var c=angular.element(b.target),e=c.scope(),f=e.btn.id,g=d.parent().find('[cs-button="'+f+'"]');a(function(){g.attr("href",e.btn.link)})}function g(e){var f=angular.element(e.target),g=void 0!==f.attr(b.attrs.button);g||(f=f.closest("["+b.attrs.button+"]"));var h=parseInt(f.attr(b.attrs.button),10);angular.forEach(c.csButtons,function(a){a.show=a.id===h}),d.css({opacity:0,position:"absolute",minWidth:"194px",minHeight:"24px"}),a(function(){var a=f.offset();a.top=Math.ceil(a.top)-d.height()-10;var b=0;b+=parseInt(f.css("padding-right")),b+=parseInt(f.css("margin-right")),a.left=Math.ceil(a.left)+f.width()-d.width()+b,d.css(a),d.animate({top:a.top+5,opacity:1},200)}),c.$apply()}d.css({opacity:0,position:"absolute"}),c.csButtons={};var h={};e(),c.$watch("html",function(){e()}),c.$on("e50RefreshEditables",e),d.parent().bind("mousedown",function(a){var b=angular.element(a.target).closest(".link-manager");b.length||angular.forEach(c.csButtons,function(a){a.show=!1})}),c.setBtnLink=function(a){h[a.id].attr("href",a.link),c.$emit("updateViewValue")}}}}]),angular.module("E50Editor").directive("e50Editor",function(){var a=['<div e50-image class="e50-image"></div>','<div e50-link class="e50-link"></div>','<div e50-button class="e50-buttons"></div>','<div e50-toolbars buttons="buttons" iframe-id="iframeId" override="override"></div>','<div class="template" e50-template ng-model="html" ng-show="!toggle"></div>','<ng-include src="footerTpl" ng-hide="toggle"></ng-include>','<textarea ng-model="html" ng-show="toggle" style="width:100%;height:100%;border: 1px solid #e4e4e4;padding:15px;"></textarea>'];return{restrict:"EA",template:a.join(""),scope:{html:"=ngModel",buttons:"=?",toggle:"=?",iframeId:"=?",override:"=?",imageSaved:"=?",aviaryOptions:"=?",footerTpl:"="}}}),angular.module("E50Editor").directive("e50Iframe",["$compile","E50Documents","E50EditorConfig",function(a,b,c){return{scope:{html:"=ngModel",toggle:"=?",buttons:"=?",override:"=?",iframeId:"@e50Iframe",imageSaved:"=?",aviaryOptions:"=?",footerTpl:"="},link:function(d,e){function f(){var e=g.contents();e.find("head").append("<style>.ng-hide{display:none !important;}body{margin:0;padding:0;}*:focus{outline:none;}"),e.find("head").append('<link href="'+c.fontAwesome+'" rel="stylesheet"/>');var f=e.find("body");f.css({margin:0,padding:0}),b.set(d.iframeId,g),d.$emit("e50Document",d.iframeId,!0,g);var h=["<div e50-editor",'ng-model="html"','toggle="toggle"','buttons="buttons"','iframe-id="iframeId"','override="override"','image-saved="imageSaved"','aviary-options="aviaryOptions"','footer-tpl="footerTpl">',"initial editable content</div>"].join(" "),i=a(h)(d);f.append(i);var j=angular.element(d.html),k=j.find("img");g.height(500),k.on("load",function(){})}d.template=d.template||"iframe-template.tpl.html",d.toggle=d.toggle||!1;var g=angular.element(document.createElement("iframe"));d.$on("$destroy",function(){g.remove(),delete b.docs[d.id],d.$emit("e50Document",d.id,!1)}),e.html(g),g=e.find("iframe"),g.load(function(){f()}),f()}}}]),angular.module("E50Editor").directive("e50Image",["$timeout","E50EditorConfig",function(a,b){var c=['<div class="popovers">','<div ng-repeat="img in imagePopovers" ng-show="img.show" ng-attr-class="img-popover-{{img.id}} image-edit"  ng-mouseenter="img.show=true">','<a href="" ng-click="toggleInput(img)" class="edit"><i class="fa  fa-ellipsis-v"></i></a>','<a href="" class="trash"><i class="fa fa-trash-o" ng-click="trash(img)"></i></a>','<form ng-submit="setImageUrl(img)">','<input type="text" ng-model="img.src" placeholder="Enter url & hit enter or" ng-if="img.showInput"/>','<a href="" ng-click="openAviary(img)" class="edit-photo" ng-if="img.showInput">Edit</a>',"</form>",'<form ng-show="img.showInput">','<input type="file" ng-attr-id="file-upload-{{img.id}}"/>',"</form>","</div>","</div>"];return{template:c.join(""),link:function(c,d){function e(e){var f=angular.element(e.target),g=parseInt(f.attr(b.attrs.placeholder),10);angular.forEach(c.imagePopovers,function(a,b){a.show=g==b});var h=f.offset(),i=d.find(".img-popover-"+g);a(function(){h.top=h.top+5,h.left=h.left+f.width()-i.width()-5,d.css(h),d.animate({opacity:1},200)}),c.$apply()}function f(a){var b=angular.element(a.toElement||a.relatedTarget),d=b.hasClass("e50-image")||b.closest(".e50-image").length;return d?!0:(angular.forEach(c.imagePopovers,function(a){a.show=!1}),void c.$apply())}function g(a){return a.preventDefault(),a.stopPropagation(),!1}function h(a){a.preventDefault(),a.stopPropagation();var b=angular.element(a.target),d=a.originalEvent.dataTransfer.files[0],e=new FileReader;return e.onload=function(a){var d=new Image;d.src=a.target.result,l.launch({image:d,onSave:function(a,e){c.imageSaved(e,d),b.attr("src",e),c.$emit("updateViewValue")}})},e.readAsDataURL(d),!1}function i(){var a=d.parent().find("["+b.attrs.placeholder+"]");angular.forEach(a,function(a,d){k[d]=a;var e=angular.element(a);e.attr(b.attrs.placeholder,d);var f=e.attr("width")||b.defaultWidth,g=e.attr("height")||b.defaultHeight,h=e.attr("src"),i=!0;if(h)i=-1!==h.indexOf(b.placeholder);else{var j=b.placeholder.replace("WIDTH",f).replace("HEIGHT",g);e.attr("src",j),e.css("border","1px solid #e7e7e7"),i=!0}c.imagePopovers[d]={id:d,show:!1,src:i?"":e.attr("src")}}),a.unbind("mouseover",e),a.unbind("mouseleave",f),a.bind("mouseover",e),a.bind("mouseleave",f),a.unbind("dragover",g),a.bind("dragover",g),a.unbind("drop",h),a.bind("drop",h),c.$emit("updateViewValue")}function j(a){if(a.target.files){var b=angular.element(a.target),d=b.attr("id").split("-").pop(),e=angular.element(k[d]),f=new Image,g=a.target.files[0],h=new FileReader;h.onload=function(a){f.src=a.target.result,l.launch({image:f,onSave:function(a,d){c.imageSaved(d,e),b.val(""),c.$emit("updateViewValue")},onClose:function(){b.val("")}})},h.readAsDataURL(g)}}c.aviaryOptions=c.aviaryOptions||"all",d.css({position:"absolute"});var k={};c.imagePopovers={};var l=new Aviary.Feather({apiKey:b.aviaryKey,tools:c.aviaryOptions,onError:function(){console.log(arguments)}});c.openAviary=function(a){if(c.isPlaceholder(a))return void alert("Please upload an image to edit");var b=angular.element(k[a.id]),d=b.attr("src"),e=c.isPlaceholder(a);if(e)return!1;var f=new Image;f.src=d,l.launch({image:f,onSave:function(a,d){c.imageSaved(d,b),b.attr("src",d),c.$emit("updateViewValue")}})},c.isPlaceholder=function(a){var b=angular.element(k[a.id]),c=b.attr("src");return-1!==c.indexOf("placehold.it")},c.trash=function(a){var d=angular.element(k[a.id]);if(c.isPlaceholder(a))d.remove();else{var e=window.confirm("Are you sure you want to delete this image?");if(!e)return!1;var f=d.attr("width")||b.defaultWidth,g=d.attr("height")||b.defaultHeight,h=b.placeholder.replace("WIDTH",f).replace("HEIGHT",g);d.attr("src",h)}a.show=!1,c.$emit("updateViewValue")},c.$watch("html",function(a,b){(a||a!==b)&&i()}),c.toggleInput=function(b){var c=angular.element(k[b.id]);b.showInput=!b.showInput,b.showInput&&a(function(){c.focus(),c[0].setSelectionRange?c[0].setSelectionRange(0,0):c.val(c.val())})},c.setImageUrl=function(a){var c=angular.element(k[a.id]),d=""!==a.src?a.src:b.placeholder;c.attr("src",d),a.showInput=!1},c.$watch("imagePopovers",function(a){if(a){var b=d.find("input");angular.forEach(b,function(a){var b=angular.element(a);b.unbind("change",j),b.bind("change",j)})}},!0)}}}]),angular.module("E50Editor").directive("e50Link",["$timeout","E50EditorConfig","E50Documents",function(a,b,c){var d=['<div class="link-manager" ng-repeat="link in links" ng-show="link.show && !toggle">','<form ng-submit="setLink(link)"><input type="text" ng-model="link.link" /></form>','<a href="" target="_blank" ng-attr-href="{{link.link}}">Open</a>','<a href="" target="_blank" ng-click="unlink(link)"><i class="fa fa-unlink"></i></a>',"</div>"];return{template:d.join(""),link:function(d,e){function f(){var a=e.parent().find("[e50-template]").find("a");angular.forEach(a,function(a,c){return a=angular.element(a),a.attr("contenteditable",!0),a.attr(b.attrs.button)?!1:(i[c]=a,a.attr(b.attrs.link,c),d.links[c]={id:c,show:!1,link:a.attr("href")||"http://"},d.setLink(d.links[c]),a.unbind("mouseup",g),void a.bind("mouseup",g))}),d.$emit("updateViewValue")}function g(c){a(function(){var f=angular.element(c.target),g="a"===c.target.tagName.toLowerCase();g||(f=f.closest("a"));var h=parseInt(f.attr(b.attrs.link),10);angular.forEach(d.links,function(a){a.show=a.id===h}),e.css({opacity:0,position:"absolute"}),a(function(){var a=f.offset();a.top=Math.ceil(a.top)-e.height()-10;var b=0;b+=parseInt(f.css("padding-right")),b+=parseInt(f.css("margin-right")),a.left=Math.ceil(a.left)+f.width()-e.width()+b,a.left<0&&(a.left=5),e.css(a),e.animate({top:a.top+5,opacity:1},200)})},50)}var h=c.get(d.iframeId);e.css({opacity:0,position:"absolute"}),d.links={};var i={};f(),d.$watch("html",function(){a(function(){f()})}),e.parent().bind("mousedown",function(a){var b=angular.element(a.target).closest(".link-manager");b.length||angular.forEach(d.links,function(a){a.show=!1,i[a.id].attr("href",a.link)})}),d.setLink=function(a){i[a.id].attr("href",a.link),d.$emit("updateViewValue")},d.unlink=function(b){var c=i[b.id];a(function(){var a=rangy.createRange();a.selectNodeContents(c[0]);var d=rangy.getIframeSelection(h[0]);d.setSingleRange(a),b.show=!1;var e=h[0].document||h[0].contentWindow.document;e.execCommand("unlink")})},d.$on("linkCreated",function(){f()})}}}]),angular.module("E50Editor").directive("e50Template",["E50Documents","E50EditorConfig","$sanitize",function(a,b){return{require:"ngModel",link:function(c,d,e,f){function g(){var a=d.find("["+b.attrs.editable+"]");c.buttons={},angular.forEach(a,function(a,d){a=angular.element(a),a.attr("contenteditable",!0),a.attr(b.attrs.editable,d);var e=c.buttons[d]?c.buttons[d].focused:!1;c.buttons[d]={id:d,focused:e,buttons:a.attr(b.attrs.format)?a.attr(b.attrs.format).split(","):[]}}),f.$setViewValue(d.html())}function h(a){var d=angular.element(a.target),e=d.closest("["+b.attrs.editable+"]"),f=d.closest(".format-button");if(!e.length&&!f.length)return void angular.forEach(c.buttons,function(a){a.focused=!1});var g=parseInt(e.attr(b.attrs.editable),10);c.buttons[g]&&angular.forEach(c.buttons,function(a){a.focused=a.id===g}),c.$apply()}function i(){f.$setViewValue(d.html()),c.$apply()}c.buttons=c.buttons||{},c.html||f.$setViewValue(d.html());var j=!1;c.$watch("html",function(a,b){return!a&&a===b||j?!1:(g(),void(j=!0))}),c.$on("e50RefreshEditables",function(){j=!1});var k=a.get(c.iframeId),l=k[0].contentDocument||k[0].contentWindow.document,m=angular.element(l||document),n=m[0]!==document;if(n)var o=angular.element(document);m.bind("mousedown",h),m.bind("mouseup",i),n&&(o.bind("mousedown",h),o.bind("mouseup",i)),c.$on("$destroy",function(){m.unbind("mousedown",h),m.unbind("mouseup",i),n&&(o.unbind("mousedown",h),o.unbind("mouseup",i))}),f.$render=function(){d.html(f.$viewValue)},f.$formatters.push(function(a){var b=angular.element(a),c=b.find("script");return c.remove(),b[0].outerHTML}),d.bind("keyup",function(){c.toggle||f.$setViewValue(d.html()),c.$apply()}),c.$on("e50AddText",function(a,b,e){if(b!==c.iframeId)return!1;var g=rangy.getIframeSelection(k[0]),h=g.getRangeAt(0),i=document.createTextNode(e);h.collapse(!1),h.insertNode(i),h.collapseAfter(i),g.setSingleRange(h),k[0].contentWindow.focus(),f.$setViewValue(d.html())}),c.$on("updateViewValue",function(){f.$setViewValue(d.html())})}}}]),angular.module("E50Editor").directive("e50Toolbars",["E50EditorButtons","E50EditorIcons","$document","E50Documents",function(a,b,c,d){var e=['<div class="toolbars" ng-if="!override">','<div class="group" ng-repeat="(key,editable) in buttons" ng-show="editable.focused">','<button type="button" unselectable="on" ng-repeat="btn in editable.buttons" class="format-button" ng-click="execute(btn)" ng-bind-html="name(btn)" ng-class="{active:isActive(btn)}"></button>',"</div>","</div>"];return{scope:{buttons:"=",iframeId:"=",override:"=?"},template:e.join(""),link:function(e){function f(b){g||(h=d.get(e.iframeId),g=h[0].contentDocument||h[0].contentWindow.document);var f=a[b];return f.iframe=h,f.setDocument(g||c[0]),f}var g,h=d.get(e.iframeId);h&&(g=h[0].contentDocument||h[0].contentWindow.document),e.name=function(c){var d=b(c);return a[c]?d?d:a[c].name:!1},e.isActive=function(a){try{return f(a).isActive()}catch(b){}},e.execute=function(a){return f(a).execute()}}}}]),angular.module("E50Editor").factory("E50BrowswerTag",function(){var a={ie:function(){for(var a,b=3,c=document.createElement("div"),d=c.getElementsByTagName("i");c.innerHTML="<!--[if gt IE "+ ++b+"]><i></i><![endif]-->",d[0];);return b>4?b:a}(),webkit:/AppleWebKit\/([\d.]+)/i.test(navigator.userAgent)};return function(b){return b?""===b?void 0===a.ie?"div":a.ie<=8?"P":"p":a.ie<=8?b.toUpperCase():b:a.ie<=8?"P":"p"}}),angular.module("E50Editor").factory("E50Documents",function(){return{docs:{},get:function(a){return"undefined"!==this.docs[a]?this.docs[a]:!1},set:function(a,b){this.docs[a]=b}}}),angular.module("E50Editor").factory("E50EditorButtons",["E50BrowswerTag","E50Documents","E50EditorConfig","$rootScope",function(a,b,c,d){function e(a){this.document=a}function f(b){this.name=b,this.isActive=function(){return this.document.queryCommandValue("formatBlock").toLowerCase()===b},this.execute=function(){var c=this.isActive()?"P":b;this.document.execCommand("formatBlock",!1,"<"+a(c)+">")},this.setDocument=e}function g(a){this.name=a,this.isActive=function(){return this.document.queryCommandState(a)},this.execute=function(){var b=this.iframe[0].document||this.iframe[0].contentWindow.document||document;b.execCommand(a)},this.setDocument=e}function h(a,b){this.name=a,this.execute=function(){var a=this.iframe[0].document||this.iframe[0].contentWindow.document||document;a.execCommand("insertHTML",!1,b)},this.isActive=angular.noop,this.setDocument=e}function i(){this.execute=function(){var a=window.prompt("Link URL:","http://"),b=this.iframe[0].document||this.iframe[0].contentWindow.document||document;b.execCommand("createLink",!1,a),d.$broadcast("linkCreated")},this.isActive=function(){return!1},this.setDocument=e}var j=["h1","h2","h3","h4","h5","h6","p","pre","blockquote"],k=["bold","italic","underline","justifyLeft","justifyCenter","justifyRight","insertOrderedList","insertUnorderedList","unlink"],l={};j.forEach(function(a){l[a]=new f(a)}),k.forEach(function(a){l[a]=new g(a)});var m=c.placeholder.replace("WIDTH",c.defaultWidth).replace("HEIGHT",c.defaultHeight);return l.placeholder=new h("placeholder",'<img src="'+m+'" class="placeholder" alt="Placeholder" cs-placeholder style="border: 1px solid rgb(231, 231, 231);"/>'),l.link=new i,l.factory=function(a){var b={FormatCommand:f,StyleCommand:g,InsertCommand:h,LinkCommand:i,ImageCommand:ImageCommand};return"undefined"!==b[a]?b[a]:!1},l}]),angular.module("E50Editor").factory("E50EditorConfig",function(){return{fontAwesome:"../bower_components/font-awesome/css/font-awesome.css",placeholder:"http://placehold.it/WIDTHxHEIGHT/f7f7f7/ccc",defaultWidth:418,defaultHeight:178,aviaryKey:null,attrs:{editable:"cs-editable",format:"cs-format",popover:"cs-popover",placeholder:"cs-placeholder",link:"cs-link",button:"cs-button"}}}),angular.module("E50Editor").factory("E50EditorIcons",function(){function a(a){return'<i class="fa '+a+'" unselectable="on">'}var b={blockquote:"fa-quote-right",bold:"fa-bold",italic:"fa-italic",underline:"fa-underline",justifyLeft:"fa-align-left",justifyCenter:"fa-align-center",justifyRight:"fa-align-right",insertOrderedList:"fa-list-ol",insertUnorderedList:"fa-list-ul",placeholder:"fa-image",link:"fa-link"};return function(c){return b[c]?a(b[c]):!1}}),angular.module("E50Editor").factory("E50ExecCommand",["taExecCommand",function(a){return a("p")}]),angular.module("E50Editor").factory("E50SelectionXY",function(){return function(){var a,b,c,d=document.selection,e=0,f=0;if(d)"Control"!=d.type&&(a=d.createRange(),a.collapse(!0),e=a.boundingLeft,f=a.boundingTop);else if(window.getSelection&&(d=window.getSelection(),d.rangeCount&&(a=d.getRangeAt(0).cloneRange(),a.getClientRects&&(a.collapse(!0),b=a.getClientRects(),b.length>0&&(c=a.getClientRects()[0]),e=c.left,f=c.top),0==e&&0==f))){var g=document.createElement("span");if(g.getClientRects){g.appendChild(document.createTextNode("​")),a.insertNode(g),c=g.getClientRects()[0],e=c.left,f=c.top;var h=g.parentNode;h.removeChild(g),h.normalize()}}return{x:e,y:f}}}),angular.module("e50Editor.tpls",["views/e50-editor.tpl.html"]),angular.module("views/e50-editor.tpl.html",[]).run(["$templateCache",function(a){a.put("views/e50-editor.tpl.html",'<div class="e50-editor">\n  \n  <a href="" ng-click="edit=!edit" class="toggle">\n    <i class="fa fa-edit"></i>\n  </a>\n  \n  <div class="format-buttons" ng-show="edit">\n    <div ng-repeat="group in toolbars">\n      <button type="button" unselectable="on" ng-repeat="button in group" ng-bind-html="name(button)" ng-click="execute(button)" ng-disabled="isDisabled()" tabindex="-1" ng-class="{active:isActive(button)}"></button>\n    </div>\n  </div>\n\n  <div class="live-editor" contenteditable="true" e50-bind ng-model="html" ng-transclude=""></div>\n\n</div>')}]);
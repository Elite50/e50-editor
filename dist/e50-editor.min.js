/*! e50-editor 2015-02-03 */
angular.module("E50Editor",["textAngular","ngSanitize"]),angular.module("E50Editor").directive("e50Editor",function(){var a=['<div e50-popover class="e50-popover"></div>','<div e50-toolbars buttons="buttons" iframe-id="iframeId" override="override"></div>','<div class="template" e50-template ng-model="html" ng-show="!toggle"></div>','<textarea ng-model="html" ng-show="toggle" style="width:100%;height:100%;border: 1px solid #e4e4e4;padding:15px;"></textarea>'];return{restrict:"EA",template:a.join(""),scope:{html:"=ngModel",buttons:"=?",toggle:"=?",iframeId:"=?",override:"=?"}}}),angular.module("E50Editor").directive("e50Iframe",["$compile","E50Documents","E50EditorConfig",function(a,b,c){return{scope:{html:"=ngModel",toggle:"=?",buttons:"=?",override:"=?",iframeId:"@e50Iframe"},link:function(d,e){d.template=d.template||"iframe-template.tpl.html";var f=angular.element(document.createElement("iframe"));d.$on("$destroy",function(){f.remove(),delete b.docs[d.id],d.$emit("e50Document",d.id,!1)}),e.html(f),f=e.find("iframe");var g=f.contents();g.find("head").append("<style>.ng-hide{display:none !important;}body{margin:0;padding:0;}*:focus{outline:none;}"),g.find("head").append('<link href="'+c.fontAwesome+'" rel="stylesheet"/>');var h=g.find("body");h.css({margin:0,padding:0}),b.set(d.iframeId,f),d.$emit("e50Document",d.iframeId,!0,f),d.popoverElm={};var i='<div e50-editor ng-model="html" toggle="toggle" buttons="buttons" iframe-id="iframeId" override="override" popover-elm="popoverElm">initial editable content</div>',j=a(i)(d);h.append(j);var k=angular.element(d.html),l=k.find("img");f.height(500),l.on("load",function(){})}}}]),angular.module("E50Editor").directive("e50Popover",["$timeout","E50Documents",function(a,b){var c=['<div class="link-manager" ng-repeat="popover in popovers" ng-show="popover.show">','<input type="text" ng-model="popover.link" />','<a href="" target="_blank" ng-attr-href="{{popover.link}}">Open</a>','<a href="" target="_blank" ng-click="unlink(popover)" ng-show="isLink(popover)"><i class="fa fa-unlink"></i></a>',"</div>"];return{template:c.join(""),link:function(c,d){var e,f=b.get(c.iframeId);c.unlink=function(b){a(function(){var a=rangy.createRange();a.selectNodeContents(e[0]);var c=rangy.getIframeSelection(f[0]);c.setSingleRange(a),e=null,b.show=!1;var d=f[0].document||f[0].contentWindow.document;d.execCommand("unlink")})},c.isButton=function(a){return-1!==a.id.indexOf("button")},c.isLink=function(a){return-1!==a.id.indexOf("link")},c.$on("e50Popover",function(b,f){e=f;var g=f.attr("popover");angular.forEach(c.popovers,function(a,b){a.show=b===g}),a(function(){var a=f.offset();a.top=a.top-d.height()-5;var b=0;b+=parseInt(f.css("padding-right")),b+=parseInt(f.css("margin-right")),a.left=Math.ceil(a.left)+f.width()-d.width()+b,d.css(a)})})}}}]),angular.module("E50Editor").directive("e50Template",["taSelection","E50Documents","$timeout",function(a,b){return{require:"ngModel",link:function(c,d,e,f){function g(){var a=$(d).find("[editable]");return a.length===m?!1:(m=a.length,c.buttons={},angular.forEach(a,function(a){var b=angular.element(a);b.attr("contenteditable",!0),c.buttons[b.attr("editable")]={focused:!1,buttons:b.attr("format")?b.attr("format").split(","):[]}}),void f.$setViewValue(d.html()))}function h(a){var b=$(a.target),d=b.closest("[editable]"),e=b.closest(".format-button");if(!d.length&&!e.length)return Object.keys(c.buttons).forEach(function(a){c.buttons[a].focused=!1}),void(c.showPopover=!1);var f=d.attr("editable");c.buttons[f]&&Object.keys(c.buttons).forEach(function(a){c.buttons[a].focused=f===a}),c.$apply()}function i(){f.$setViewValue(d.html()),c.$apply()}function j(a){var b=angular.element(a.target),d=b.closest(".e50-popover");return d.length||b.attr("popover")?(c.showPopover=!0,c.$emit("e50Popover",b),void c.$apply()):(c.showPopover=!1,void angular.forEach(c.popovers,function(a){a.show=!1}))}function k(){var a=angular.element(d),b=a.find("[popover]");return b.length===t?!1:(t=b.length,u={},c.popovers={},void angular.forEach(b,function(a,b){for(var d=angular.element(a),e=d.attr("popover");u[e];)e+=b;d.attr("popover",e),u[e]=d,c.popovers[e]={id:e,link:d.attr("href")||"http://",show:!1}}))}function l(a){var b=angular.element(a.target),e="a"===a.target.tagName.toLowerCase()||b.closest("a").length;if(e){var g=b.attr("popover");if(!g){for(g="link:1";u[g];)g+=1;b.attr("popover",g),u[g]=b,f.$setViewValue(d.html()),c.$apply()}}}c.buttons=c.buttons||{},c.html||f.$setViewValue(d.html());var m=$(d).find("[editable]").length;c.$watch("html",function(a,b){return a||a!==b?void g():!1});var n=b.get(c.iframeId),o=n[0].contentDocument||n[0].contentWindow.document,p=angular.element(o||document),q=p[0]!==document;if(q)var r=angular.element(document);p.bind("mousedown",h),p.bind("mouseup",i),q&&(r.bind("mousedown",h),r.bind("mouseup",i)),c.$on("$destroy",function(){p.unbind("mousedown",h),p.unbind("mouseup",i),q&&(r.unbind("mousedown",h),r.unbind("mouseup",i))}),f.$render=function(){d.html(f.$viewValue)},d.bind("keyup",function(){f.$setViewValue(d.html()),c.$apply()}),d.bind("dragover",function(a){a.preventDefault(),a.stopPropagation(),d.addClass("drag-over")}),d.bind("dragleave",function(a){a.preventDefault(),a.stopPropagation(),d.removeClass("drag-over")});var s=function(b){b.preventDefault(),b.stopPropagation();var e=angular.element(b.target),g=e.closest("[editable]");if(!g.length)return!1;if(e.hasClass("placeholder")){var h=q?p:r,i=a(h);i.setSelectionToElementStart(b.target)}var j=b.originalEvent.dataTransfer;return angular.forEach(j.files,function(a){var b=/image.*/;if(!a.type.match(b))return void alert("Only images allowed");var g=new FileReader;g.onload=function(a){if(e.hasClass("placeholder"))e.attr("src",a.target.result),e.removeClass("placeholder");else{var b=$("<img/>");b.attr("src",a.target.result),b.css({width:"100%"}),b.insertAfter(e)}d.removeClass("drag-over"),f.$setViewValue(d.html()),c.$apply()},g.readAsDataURL(a)}),!1};d.bind("drop",s),c.popovers={},d.bind("mousedown",j),q&&r.bind("mousedown",j);var t=!1,u={};c.$watch("html",function(a,b){(a||a!==b)&&k()}),c.$watch("popovers",function(){angular.forEach(c.popovers,function(a,b){u[b]&&u[b].attr("href",a.link)}),f.$setViewValue(d.html())},!0),c.$on("$destroy",function(){d.unbind("drop",s),r.unbind("mousedown",j)}),d.bind("mousedown",l),c.$on("e50AddText",function(a,b,e){if(b!==c.iframeId)return!1;var g=rangy.getIframeSelection(n[0]),h=g.getRangeAt(0);h.insertNode(document.createTextNode(e)),f.$setViewValue(d.html())})}}}]),angular.module("E50Editor").directive("e50Toolbars",["E50EditorButtons","E50EditorIcons","$document","E50Documents",function(a,b,c,d){var e=['<div class="toolbars" ng-if="!override">','<div class="group" ng-repeat="(key,editable) in buttons" ng-show="editable.focused">','<button type="button" unselectable="on" ng-repeat="btn in editable.buttons" class="format-button" ng-click="execute(btn)" ng-bind-html="name(btn)" ng-class="{active:isActive(btn)}"></button>',"</div>","</div>"];return{scope:{buttons:"=",iframeId:"=",override:"=?"},template:e.join(""),link:function(e){function f(b){g||(h=d.get(e.iframeId),g=h[0].contentDocument||h[0].contentWindow.document);var f=a[b];return f.setDocument(g||c[0]),f}var g,h=d.get(e.iframeId);h&&(g=h[0].contentDocument||h[0].contentWindow.document),e.name=function(c){var d=b(c);return a[c]?d?d:a[c].name:!1},e.isActive=function(a){try{return f(a).isActive()}catch(b){}},e.execute=function(a){return f(a).execute()}}}}]),angular.module("E50Editor").factory("E50Documents",function(){return{docs:{},get:function(a){return"undefined"!==this.docs[a]?this.docs[a]:!1},set:function(a,b){this.docs[a]=b}}}),angular.module("E50Editor").factory("E50EditorButtons",["taBrowserTag","taSelection","taExecCommand","E50Documents",function(a,b,c){function d(a){this.document=a}function e(b){this.name=b,this.isActive=function(){return this.document.queryCommandValue("formatBlock").toLowerCase()===b},this.execute=function(){var c=this.isActive()?"P":b;this.document.execCommand("formatBlock",!1,"<"+a(c)+">")},this.setDocument=d}function f(a){this.name=a,this.isActive=function(){return this.document.queryCommandState(a)},this.execute=function(){var b=c(this.document)("p");b(a)},this.setDocument=d}function g(){this.name="image",this.isActive=function(){if(!this.document)return!1;var a=b(this.document),c=a.getSelectionElement();return"IMG"===c.tagName},this.execute=function(){var a=c(this.document)("p"),b=window.prompt("Image url","http://");a("insertImage",!1,b)},this.setDocument=d}function h(a,b){this.name=a,this.execute=function(){var a=c(this.document)("p");a("insertHTML",!1,b)},this.isActive=angular.noop,this.setDocument=d}function i(){this.execute=function(){var a=c(this.document)("p"),b=window.prompt("Link URL:","http://");a("createLink",!1,b)},this.isActive=function(){if(!this.document)return!1;var a=b(this.document),c=a.getSelectionElement();return $(c).closest("a").length},this.setDocument=d}var j=["h1","h2","h3","h4","h5","h6","p","pre","blockquote"],k=["bold","italic","underline","justifyLeft","justifyCenter","justifyRight","insertOrderedList","insertUnorderedList","unlink"],l={};return j.forEach(function(a){l[a]=new e(a)}),k.forEach(function(a){l[a]=new f(a)}),l.image=new g,l.placeholder=new h("placeholder",'<img src="placeholder.png" class="placeholder" alt="Placeholder"/>'),l.link=new i,l.factory=function(a){var b={FormatCommand:e,StyleCommand:f,InsertCommand:h,LinkCommand:i,ImageCommand:g};return"undefined"!==b[a]?b[a]:!1},l}]),angular.module("E50Editor").factory("E50EditorConfig",function(){return{fontAwesome:"../bower_components/font-awesome/css/font-awesome.css"}}),angular.module("E50Editor").factory("E50EditorIcons",function(){function a(a){return'<i class="fa '+a+'" unselectable="on">'}var b={blockquote:"fa-quote-right",bold:"fa-bold",italic:"fa-italic",underline:"fa-underline",justifyLeft:"fa-align-left",justifyCenter:"fa-align-center",justifyRight:"fa-align-right",insertOrderedList:"fa-list-ol",insertUnorderedList:"fa-list-ul",placeholder:"fa-image",link:"fa-link"};return function(c){return b[c]?a(b[c]):!1}}),angular.module("E50Editor").factory("E50ExecCommand",["taExecCommand",function(a){return a("p")}]),angular.module("E50Editor").factory("E50SelectionXY",function(){return function(){var a,b,c,d=document.selection,e=0,f=0;if(d)"Control"!=d.type&&(a=d.createRange(),a.collapse(!0),e=a.boundingLeft,f=a.boundingTop);else if(window.getSelection&&(d=window.getSelection(),d.rangeCount&&(a=d.getRangeAt(0).cloneRange(),a.getClientRects&&(a.collapse(!0),b=a.getClientRects(),b.length>0&&(c=a.getClientRects()[0]),e=c.left,f=c.top),0==e&&0==f))){var g=document.createElement("span");if(g.getClientRects){g.appendChild(document.createTextNode("​")),a.insertNode(g),c=g.getClientRects()[0],e=c.left,f=c.top;var h=g.parentNode;h.removeChild(g),h.normalize()}}return{x:e,y:f}}}),angular.module("e50Editor.tpls",["views/e50-editor.tpl.html"]),angular.module("views/e50-editor.tpl.html",[]).run(["$templateCache",function(a){a.put("views/e50-editor.tpl.html",'<div class="e50-editor">\n  \n  <a href="" ng-click="edit=!edit" class="toggle">\n    <i class="fa fa-edit"></i>\n  </a>\n  \n  <div class="format-buttons" ng-show="edit">\n    <div ng-repeat="group in toolbars">\n      <button type="button" unselectable="on" ng-repeat="button in group" ng-bind-html="name(button)" ng-click="execute(button)" ng-disabled="isDisabled()" tabindex="-1" ng-class="{active:isActive(button)}"></button>\n    </div>\n  </div>\n\n  <div class="live-editor" contenteditable="true" e50-bind ng-model="html" ng-transclude=""></div>\n\n</div>')}]);